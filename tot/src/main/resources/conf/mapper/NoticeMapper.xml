<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="tot.dao.NoticeDao">

	<resultMap id="NoticeResultMap" type="tot.domain.Notice">
	    <id property="noid" column="NOID"/>
	    <result property="notitle" column="NOTITLE"/>
	    <result property="notext" column="NOTEXT"/>
	    <result property="noregdate" column="NOREGDATE"/>
	    <result property="noupdate" column="NOUPDATE"/>
	</resultMap>

    <!-- 페이징 처리를 위한 공지사항 목록 조회 -->
    <select id="NoticeList" parameterType="tot.common.page.PageDTO" resultType="tot.domain.Notice">
        SELECT * 
        FROM NOTICE 
        ORDER BY NOID DESC
        LIMIT #{pageRowCount} OFFSET #{offset}
    </select>
    
	<select id="noticeListWithPaging" parameterType="tot.common.page.PageDTO" resultMap="NoticeResultMap">
    SELECT *
    FROM (
        SELECT NOID, NOTITLE, NOTEXT, NOREGDATE, NOUPDATE,
               ROW_NUMBER() OVER(
                   ORDER BY NOREGDATE DESC  <!-- 최신순으로 정렬 -->
               ) AS rn
        FROM NOTICE
        <where>  <!-- WHERE 절을 사용하여 조건을 동적으로 추가 -->
            <if test="dto.search != null and dto.search != ''">
                <choose>
                    <when test="dto.searchType.name() == 'TITLE'">
                        AND NOTITLE LIKE '%' || #{dto.search} || '%'
                    </when>
                    <when test="dto.searchType.name() == 'CONTENT'">
                        AND NOTEXT LIKE '%' || #{dto.search} || '%'
                    </when>
                    <when test="dto.searchType.name() == 'ALL'">
                        AND (NOTITLE LIKE '%' || #{dto.search} || '%'
                        OR NOTEXT LIKE '%' || #{dto.search} || '%')
                    </when>
                </choose>
            </if>
        </where>
    )
	    WHERE rn BETWEEN #{offset} AND #{offset} + #{pageRowCount}  <!-- 페이징 처리 -->
	</select>

	
    <!-- 총 게시물 수 조회 -->
	<select id="selectNoticeTotalCount" parameterType="tot.common.page.PageDTO" resultType="int">
    SELECT COUNT(*)
    FROM NOTICE
	    <where>
	        <!-- 검색어가 있는 경우 -->
	        <if test="dto.search != null and dto.search != ''">
	            <choose>
	                <!-- 제목으로 검색 -->
	                <when test="dto.searchType.name() == 'TITLE'">
	                    NOTITLE LIKE '%' || #{dto.search} || '%'
	                </when>
	                <!-- 내용으로 검색 -->
	                <when test="dto.searchType.name() == 'CONTENT'">
	                    NOTEXT LIKE '%' || #{dto.search} || '%'
	                </when>
	                <!-- 제목 또는 내용으로 검색 -->
	                <when test="dto.searchType.name() == 'ALL'">
	                    (NOTITLE LIKE '%' || #{dto.search} || '%'
	                    OR NOTEXT LIKE '%' || #{dto.search} || '%')
	                </when>
	            </choose>
	        </if>
	    </where>
	</select>

    <!-- 개별 공지사항 조회 -->
	<select id="getNoticeById" parameterType="int" resultMap="NoticeResultMap">
	    SELECT * FROM NOTICE WHERE NOID = #{noid}
	</select>
    
    <!-- 공지사항 등록 -->
    <insert id="insertNotice" parameterType="tot.domain.Notice">
        INSERT INTO NOTICE (noid, notitle, notext, noregdate)
        VALUES (SEQ_NOID.NEXTVAL, #{notitle}, #{notext}, SYSDATE)
    </insert>
    
    <!-- 공지사항 삭제 -->
	<delete id="deleteNotice" parameterType="int">
	    DELETE FROM NOTICE WHERE NOID = #{noid}
	</delete>
	
    <!-- 공지사항 수정 -->
    <update id="updateNotice" parameterType="tot.domain.Notice">
        UPDATE NOTICE 
        SET NOTITLE = #{notitle}, NOTEXT = #{notext}, NOUPDATE = SYSDATE
        WHERE NOID = #{noid}
    </update>


</mapper>
